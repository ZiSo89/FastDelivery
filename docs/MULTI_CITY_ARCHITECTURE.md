# ğŸ™ï¸ Fast Delivery - Multi-City Architecture Plan

**Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±:** 2025-12-05  
**ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·:** ğŸ“‹ Î£Ï‡ÎµÎ´Î¹Î±ÏƒÎ¼ÏŒÏ‚ (Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯)  
**Î•ÎºÏ„Î¹Î¼ÏÎ¼ÎµÎ½Î¿Ï‚ Ï‡ÏÏŒÎ½Î¿Ï‚ Ï…Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚:** 30-50 ÏÏÎµÏ‚

---

## ğŸ“Š Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î‘ÏÏ‡Î¹Ï„ÎµÎºÏ„Î¿Î½Î¹ÎºÎ® (Single-City)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FAST DELIVERY                        â”‚
â”‚                   (Î‘Î»ÎµÎ¾Î±Î½Î´ÏÎ¿ÏÏ€Î¿Î»Î·)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1 Admin â†’ Î’Î»Î­Ï€ÎµÎ¹ ÎŸÎ›Î‘                                  â”‚
â”‚  N Stores â†’ Î§Ï‰ÏÎ¯Ï‚ Ï†Î¯Î»Ï„ÏÎ¿ Ï€ÏŒÎ»Î·Ï‚                         â”‚
â”‚  N Drivers â†’ Î§Ï‰ÏÎ¯Ï‚ Ï†Î¯Î»Ï„ÏÎ¿ Ï€ÏŒÎ»Î·Ï‚                        â”‚
â”‚  N Customers â†’ Î’Î»Î­Ï€Î¿Ï…Î½ ÎŸÎ›Î‘ Ï„Î± ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î±              â”‚
â”‚  N Orders â†’ Î§Ï‰ÏÎ¯Ï‚ Ï†Î¯Î»Ï„ÏÎ¿ Ï€ÏŒÎ»Î·Ï‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Î ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î¿Î¯:**
- Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î±Î½Î¬ Ï€ÏŒÎ»Î·
- ÎˆÎ½Î±Ï‚ admin Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï„Î± Ï€Î¬Î½Ï„Î±
- Î ÎµÎ»Î¬Ï„ÎµÏ‚ Î²Î»Î­Ï€Î¿Ï…Î½ ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î± Î±Ï€ÏŒ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Ï€ÎµÏÎ¹Î¿Ï‡Î­Ï‚
- Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ (ÏÏÎµÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚, Ï„Î¹Î¼Î­Ï‚) ÎµÎ¯Î½Î±Î¹ ÎºÎ±Î¸Î¿Î»Î¹ÎºÎ­Ï‚

---

## ğŸ¯ Î£Ï„ÏŒÏ‡Î¿Ï‚: Multi-City / Multi-Tenant Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FAST DELIVERY                               â”‚
â”‚                        (Multi-City)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎ¥Î ÎŸÎ›Î—  â”‚  â”‚     ÎšÎ‘Î’Î‘Î›Î‘      â”‚  â”‚     ÎÎ‘ÎÎ˜Î—       â”‚     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  â”‚ City Admin      â”‚  â”‚ City Admin      â”‚  â”‚ City Admin      â”‚     â”‚
â”‚  â”‚ Local Stores    â”‚  â”‚ Local Stores    â”‚  â”‚ Local Stores    â”‚     â”‚
â”‚  â”‚ Local Drivers   â”‚  â”‚ Local Drivers   â”‚  â”‚ Local Drivers   â”‚     â”‚
â”‚  â”‚ Local Customers â”‚  â”‚ Local Customers â”‚  â”‚ Local Customers â”‚     â”‚
â”‚  â”‚ Local Orders    â”‚  â”‚ Local Orders    â”‚  â”‚ Local Orders    â”‚     â”‚
â”‚  â”‚ Local Settings  â”‚  â”‚ Local Settings  â”‚  â”‚ Local Settings  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚    SUPER ADMIN      â”‚                         â”‚
â”‚                    â”‚  (Î’Î»Î­Ï€ÎµÎ¹ Ï„Î± Ï€Î¬Î½Ï„Î±)  â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Database Schema Changes

### 1. ÎÎ­Î¿ Model: City

```javascript
// fast-delivery-backend/src/models/City.js

const citySchema = new mongoose.Schema({
  // Î’Î±ÏƒÎ¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±
  name: {
    type: String,
    required: true,
    unique: true
  },
  slug: {
    type: String,
    required: true,
    unique: true,
    lowercase: true
    // Ï€.Ï‡. "alexandroupoli", "kavala", "xanthi"
  },
  
  // Î“ÎµÏ‰Î³ÏÎ±Ï†Î¹ÎºÎ¬ ÏŒÏÎ¹Î± (Polygon Î³Î¹Î± Î­Î»ÎµÎ³Ï‡Î¿ Î±Î½ Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î±Î½Î®ÎºÎµÎ¹ ÏƒÏ„Î·Î½ Ï€ÏŒÎ»Î·)
  boundaries: {
    type: {
      type: String,
      enum: ['Polygon'],
      default: 'Polygon'
    },
    coordinates: {
      type: [[[Number]]], // Array of arrays of [lng, lat] pairs
      required: true
    }
  },
  
  // ÎšÎ­Î½Ï„ÏÎ¿ Ï€ÏŒÎ»Î·Ï‚ (Î³Î¹Î± default map view)
  center: {
    type: {
      type: String,
      enum: ['Point'],
      default: 'Point'
    },
    coordinates: {
      type: [Number], // [lng, lat]
      required: true
    }
  },
  
  // Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î±Î½Î¬ Ï€ÏŒÎ»Î·
  settings: {
    // ÎÏÎµÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚
    serviceHoursEnabled: { type: Boolean, default: false },
    serviceHoursStart: { type: String, default: '09:00' },
    serviceHoursEnd: { type: String, default: '23:00' },
    
    // ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ¬
    defaultDeliveryFee: { type: Number, default: 2.5 },
    driverSalary: { type: Number, default: 800 },
    
    // Î¤ÏÏ€Î¿Î¹ ÎºÎ±Ï„Î±ÏƒÏ„Î·Î¼Î¬Ï„Ï‰Î½ (Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï†Î­ÏÎ¿Ï…Î½ Î±Î½Î¬ Ï€ÏŒÎ»Î·)
    storeTypes: [{
      name: String,
      icon: String
    }],
    
    // Timezone (Î±Î½ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î³Î¹Î± Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ­Ï‚ Ï‡ÏÏÎµÏ‚)
    timezone: { type: String, default: 'Europe/Athens' }
  },
  
  // ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
  isActive: { type: Boolean, default: true },
  
  // Timestamps
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now }
});

// Indexes
citySchema.index({ slug: 1 });
citySchema.index({ boundaries: '2dsphere' });
citySchema.index({ center: '2dsphere' });
```

### 2. Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ·: Admin Model

```javascript
// fast-delivery-backend/src/models/Admin.js

const adminSchema = new mongoose.Schema({
  // ... existing fields ...
  
  // ÎÎ•Î‘ Î Î•Î”Î™Î‘
  role: {
    type: String,
    enum: ['superadmin', 'city_admin'],
    default: 'city_admin'
  },
  
  city: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'City',
    required: function() {
      return this.role === 'city_admin';
    }
    // null/undefined Î³Î¹Î± superadmin
  },
  
  // Permissions (Î³Î¹Î± Î¼ÎµÎ»Î»Î¿Î½Ï„Î¹ÎºÎ® ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ·)
  permissions: {
    canManageStores: { type: Boolean, default: true },
    canManageDrivers: { type: Boolean, default: true },
    canManageOrders: { type: Boolean, default: true },
    canViewStatistics: { type: Boolean, default: true },
    canEditSettings: { type: Boolean, default: true },
    canManageCities: { type: Boolean, default: false } // Î¼ÏŒÎ½Î¿ superadmin
  }
});
```

### 3. Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ·: Store Model

```javascript
// fast-delivery-backend/src/models/Store.js

const storeSchema = new mongoose.Schema({
  // ... existing fields ...
  
  // ÎÎ•ÎŸ Î Î•Î”Î™ÎŸ
  city: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'City',
    required: true,
    index: true
  }
});

// Compound indexes Î³Î¹Î± Î³ÏÎ®Î³Î¿ÏÎ± queries
storeSchema.index({ city: 1, isApproved: 1 });
storeSchema.index({ city: 1, isOnline: 1 });
```

### 4. Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ·: Driver Model

```javascript
// fast-delivery-backend/src/models/Driver.js

const driverSchema = new mongoose.Schema({
  // ... existing fields ...
  
  // ÎÎ•ÎŸ Î Î•Î”Î™ÎŸ
  city: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'City',
    required: true,
    index: true
  }
});

// Compound indexes
driverSchema.index({ city: 1, isApproved: 1 });
driverSchema.index({ city: 1, isAvailable: 1 });
```

### 5. Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ·: Order Model

```javascript
// fast-delivery-backend/src/models/Order.js

const orderSchema = new mongoose.Schema({
  // ... existing fields ...
  
  // ÎÎ•ÎŸ Î Î•Î”Î™ÎŸ
  city: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'City',
    required: true,
    index: true
  }
});

// Compound indexes Î³Î¹Î± Î³ÏÎ®Î³Î¿ÏÎ± queries
orderSchema.index({ city: 1, status: 1 });
orderSchema.index({ city: 1, createdAt: -1 });
```

### 6. Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ·: Customer Model

```javascript
// fast-delivery-backend/src/models/Customer.js

const customerSchema = new mongoose.Schema({
  // ... existing fields ...
  
  // ÎÎ•ÎŸ Î Î•Î”Î™ÎŸ - Î ÏŒÎ»Î· Ï„Î¿Ï… Ï€ÎµÎ»Î¬Ï„Î· (based on address)
  city: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'City',
    required: true,
    index: true
  },
  
  // Î‰ ÎµÎ½Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ¬: Ï€Î¿Î»Î»Î­Ï‚ Î´Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÎ¹Ï‚ ÏƒÎµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ­Ï‚ Ï€ÏŒÎ»ÎµÎ¹Ï‚
  addresses: [{
    label: String, // "Î£Ï€Î¯Ï„Î¹", "Î”Î¿Ï…Î»ÎµÎ¹Î¬"
    address: String,
    city: { type: mongoose.Schema.Types.ObjectId, ref: 'City' },
    location: {
      type: { type: String, enum: ['Point'], default: 'Point' },
      coordinates: [Number]
    },
    isDefault: Boolean
  }]
});
```

### 7. Î¤ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ·: MonthlyExpense Model

```javascript
// fast-delivery-backend/src/models/MonthlyExpense.js

const monthlyExpenseSchema = new mongoose.Schema({
  // ... existing fields ...
  
  // ÎÎ•ÎŸ Î Î•Î”Î™ÎŸ
  city: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'City',
    required: true
  }
});

// Compound index
monthlyExpenseSchema.index({ city: 1, year: 1, month: 1 }, { unique: true });
```

---

## ğŸ”§ Backend API Changes

### 1. Middleware: City Context

```javascript
// fast-delivery-backend/src/middleware/cityContext.js

const City = require('../models/City');

// Middleware Ï€Î¿Ï… Ï€ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ Ï„Î¿ city context ÏƒÎµ ÎºÎ¬Î¸Îµ request
const cityContext = async (req, res, next) => {
  try {
    // Î‘Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ÎµÎ¯Î½Î±Î¹ superadmin, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹ Ï€ÏŒÎ»Î·
    if (req.user.role === 'superadmin') {
      // Î ÏŒÎ»Î· Î±Ï€ÏŒ query param Î® header
      const citySlug = req.query.city || req.headers['x-city'];
      if (citySlug) {
        const city = await City.findOne({ slug: citySlug, isActive: true });
        req.city = city;
      }
      // Î‘Î½ Î´ÎµÎ½ Î´Î¿Î¸ÎµÎ¯ Ï€ÏŒÎ»Î·, superadmin Î²Î»Î­Ï€ÎµÎ¹ Ï„Î± Ï€Î¬Î½Ï„Î± (req.city = null)
    } 
    // Î‘Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ÎµÎ¯Î½Î±Î¹ city_admin, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î· Î´Î¹ÎºÎ® Ï„Î¿Ï… Ï€ÏŒÎ»Î·
    else if (req.user.role === 'city_admin') {
      req.city = await City.findById(req.user.city);
    }
    // Î“Î¹Î± stores/drivers, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î·Î½ Ï€ÏŒÎ»Î· Ï„Î¿Ï…Ï‚
    else if (req.user.city) {
      req.city = await City.findById(req.user.city);
    }
    
    next();
  } catch (error) {
    next(error);
  }
};

module.exports = cityContext;
```

### 2. Helper: City Filter

```javascript
// fast-delivery-backend/src/utils/cityFilter.js

// Î ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ city filter ÏƒÎµ queries
const addCityFilter = (query, req) => {
  // Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ city context, Ï†Î¹Î»Ï„ÏÎ¬ÏÎµÎ¹
  if (req.city) {
    query.city = req.city._id;
  }
  // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ (superadmin Ï‡Ï‰ÏÎ¯Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î®), ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Ï„Î± Ï€Î¬Î½Ï„Î±
  return query;
};

module.exports = { addCityFilter };
```

### 3. Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±: Updated Controller

```javascript
// fast-delivery-backend/src/controllers/adminController.js

const { addCityFilter } = require('../utils/cityFilter');

// Î Î¡Î™Î (Single-City)
const getOrders = async (req, res) => {
  const orders = await Order.find({ status: 'pending' });
  res.json(orders);
};

// ÎœÎ•Î¤Î‘ (Multi-City)
const getOrders = async (req, res) => {
  const filter = addCityFilter({ status: 'pending' }, req);
  const orders = await Order.find(filter);
  res.json(orders);
};
```

### 4. ÎÎ­Î± Routes: City Management

```javascript
// fast-delivery-backend/src/routes/city.js

const express = require('express');
const router = express.Router();
const { protect, superAdminOnly } = require('../middleware/auth');

// GET /api/v1/cities - Î›Î¯ÏƒÏ„Î± Ï€ÏŒÎ»ÎµÏ‰Î½
router.get('/', protect, getCities);

// POST /api/v1/cities - Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï€ÏŒÎ»Î·Ï‚ (superadmin only)
router.post('/', protect, superAdminOnly, createCity);

// PUT /api/v1/cities/:id - Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï€ÏŒÎ»Î·Ï‚
router.put('/:id', protect, superAdminOnly, updateCity);

// DELETE /api/v1/cities/:id - Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï€ÏŒÎ»Î·Ï‚
router.delete('/:id', protect, superAdminOnly, deactivateCity);

// GET /api/v1/cities/:id/stats - Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ Ï€ÏŒÎ»Î·Ï‚
router.get('/:id/stats', protect, getCityStats);

module.exports = router;
```

### 5. ÎÎ­Î¿ Endpoint: Detect City by Location

```javascript
// POST /api/v1/cities/detect
// Body: { lat: 40.8457, lng: 25.8733 }
// Response: { city: { _id, name, slug } }

const detectCity = async (req, res) => {
  const { lat, lng } = req.body;
  
  const city = await City.findOne({
    boundaries: {
      $geoIntersects: {
        $geometry: {
          type: 'Point',
          coordinates: [lng, lat]
        }
      }
    },
    isActive: true
  });
  
  if (!city) {
    return res.status(404).json({ 
      message: 'Î— Ï…Ï€Î·ÏÎµÏƒÎ¯Î± Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· ÏƒÏ„Î·Î½ Ï€ÎµÏÎ¹Î¿Ï‡Î® ÏƒÎ±Ï‚' 
    });
  }
  
  res.json({ city });
};
```

---

## ğŸ–¥ï¸ Frontend Changes

### 1. Super Admin Dashboard

```javascript
// ÎÎ­Î¿ component: CitySelector.js
// Dropdown Î³Î¹Î± ÎµÏ€Î¹Î»Î¿Î³Î® Ï€ÏŒÎ»Î·Ï‚ (ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ ÏƒÎµ superadmin)

const CitySelector = () => {
  const [cities, setCities] = useState([]);
  const [selectedCity, setSelectedCity] = useState(null);
  
  // Î‘Î»Î»Î±Î³Î® Ï€ÏŒÎ»Î·Ï‚ ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÎ¹ Ï„Î¿ context ÎºÎ±Î¹ Ï„Î± data
  const handleCityChange = (citySlug) => {
    setSelectedCity(citySlug);
    // Refetch all data with new city filter
  };
  
  return (
    <Dropdown>
      <Dropdown.Toggle>
        {selectedCity ? selectedCity.name : 'ÎŒÎ»ÎµÏ‚ Î¿Î¹ Ï€ÏŒÎ»ÎµÎ¹Ï‚'}
      </Dropdown.Toggle>
      <Dropdown.Menu>
        <Dropdown.Item onClick={() => handleCityChange(null)}>
          ÎŒÎ»ÎµÏ‚ Î¿Î¹ Ï€ÏŒÎ»ÎµÎ¹Ï‚
        </Dropdown.Item>
        {cities.map(city => (
          <Dropdown.Item 
            key={city._id} 
            onClick={() => handleCityChange(city)}
          >
            {city.name}
          </Dropdown.Item>
        ))}
      </Dropdown.Menu>
    </Dropdown>
  );
};
```

### 2. ÎÎ­Î¿ Tab: Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î ÏŒÎ»ÎµÏ‰Î½

```javascript
// components/admin/CitiesTab.js

// Features:
// - Î›Î¯ÏƒÏ„Î± Ï€ÏŒÎ»ÎµÏ‰Î½ Î¼Îµ status (Active/Inactive)
// - Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î½Î­Î±Ï‚ Ï€ÏŒÎ»Î·Ï‚
// - Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÏÏ…Î¸Î¼Î¯ÏƒÎµÏ‰Î½ Ï€ÏŒÎ»Î·Ï‚
// - Î‘Î½Î¬Î¸ÎµÏƒÎ· City Admin
// - Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ Î±Î½Î¬ Ï€ÏŒÎ»Î· (overview)
// - Î§Î¬ÏÏ„Î·Ï‚ Î¼Îµ polygons Ï„Ï‰Î½ Ï€ÎµÏÎ¹Î¿Ï‡ÏÎ½
```

### 3. City Admin Î ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î¿Î¯

```javascript
// AuthContext.js Î® ProtectedRoute.js

// City admin Î´ÎµÎ½ Î²Î»Î­Ï€ÎµÎ¹:
// - Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î ÏŒÎ»ÎµÏ‰Î½ tab
// - Dropdown ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ Ï€ÏŒÎ»Î·Ï‚
// - Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î¬Î»Î»Ï‰Î½ Ï€ÏŒÎ»ÎµÏ‰Î½

// City admin Î²Î»Î­Ï€ÎµÎ¹ Î¼ÏŒÎ½Î¿:
// - Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î·Ï‚ Î´Î¹ÎºÎ®Ï‚ Ï„Î¿Ï… Ï€ÏŒÎ»Î·Ï‚
// - Î¤Î¹Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Ï„Î·Ï‚ Î´Î¹ÎºÎ®Ï‚ Ï„Î¿Ï… Ï€ÏŒÎ»Î·Ï‚
```

---

## ğŸ“± Mobile App Changes

### 1. Customer App: City Selection

```javascript
// screens/CitySelectScreen.js (Î½Î­Î¿)
// Î•Î¼Ï†Î±Î½Î¯Î¶ÎµÏ„Î±Î¹ ÎºÎ±Ï„Î¬ Ï„Î¿ Ï€ÏÏÏ„Î¿ Î¬Î½Î¿Î¹Î³Î¼Î± Î® Î±Î½ GPS Î´ÎµÎ½ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯

const CitySelectScreen = () => {
  const [cities, setCities] = useState([]);
  
  return (
    <View>
      <Text>Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î·Î½ Ï€ÏŒÎ»Î· ÏƒÎ±Ï‚</Text>
      <FlatList
        data={cities}
        renderItem={({ item }) => (
          <TouchableOpacity onPress={() => selectCity(item)}>
            <Text>{item.name}</Text>
          </TouchableOpacity>
        )}
      />
    </View>
  );
};
```

### 2. Customer App: Auto-Detect City

```javascript
// services/cityService.js

const detectUserCity = async () => {
  try {
    // Î Î¬ÏÎµ GPS location
    const location = await Location.getCurrentPositionAsync();
    
    // Î£Ï„ÎµÎ¯Î»Îµ ÏƒÏ„Î¿ backend Î³Î¹Î± detect
    const response = await api.post('/cities/detect', {
      lat: location.coords.latitude,
      lng: location.coords.longitude
    });
    
    return response.data.city;
  } catch (error) {
    // Fallback: Î–Î®Ï„Î± Î±Ï€ÏŒ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· Î½Î± ÎµÏ€Î¹Î»Î­Î¾ÎµÎ¹
    return null;
  }
};
```

### 3. City Context ÏƒÏ„Î¿ App

```javascript
// context/CityContext.js

const CityContext = createContext();

export const CityProvider = ({ children }) => {
  const [city, setCity] = useState(null);
  
  // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚
  useEffect(() => {
    if (city) {
      AsyncStorage.setItem('selectedCity', JSON.stringify(city));
    }
  }, [city]);
  
  return (
    <CityContext.Provider value={{ city, setCity }}>
      {children}
    </CityContext.Provider>
  );
};
```

---

## ğŸ”„ Migration Plan

### Phase 1: Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± (Î§Ï‰ÏÎ¯Ï‚ breaking changes)

1. âœ… Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± City model
2. âœ… Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· `city` field ÏƒÎµ ÏŒÎ»Î± Ï„Î± models (optional, default null)
3. âœ… Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± default City "Î‘Î»ÎµÎ¾Î±Î½Î´ÏÎ¿ÏÏ€Î¿Î»Î·"
4. âœ… Migration script: Î‘Î½Î¬Î¸ÎµÏƒÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï…Ï€Î±ÏÏ‡ÏŒÎ½Ï„Ï‰Î½ records ÏƒÏ„Î·Î½ default city

```javascript
// migration/001_add_cities.js

const migrateToMultiCity = async () => {
  // 1. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± default city
  const defaultCity = await City.create({
    name: 'Î‘Î»ÎµÎ¾Î±Î½Î´ÏÎ¿ÏÏ€Î¿Î»Î·',
    slug: 'alexandroupoli',
    center: { type: 'Point', coordinates: [25.8733, 40.8457] },
    boundaries: { /* polygon coordinates */ },
    isActive: true
  });
  
  // 2. Î‘Î½Î¬Î¸ÎµÏƒÎ· ÏƒÎµ ÏŒÎ»Î± Ï„Î± Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î± records
  await Store.updateMany({}, { city: defaultCity._id });
  await Driver.updateMany({}, { city: defaultCity._id });
  await Customer.updateMany({}, { city: defaultCity._id });
  await Order.updateMany({}, { city: defaultCity._id });
  await MonthlyExpense.updateMany({}, { city: defaultCity._id });
  
  // 3. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· admin ÏƒÎµ superadmin
  await Admin.updateMany({}, { role: 'superadmin', city: null });
  
  console.log('Migration completed!');
};
```

### Phase 2: Backend Updates

1. Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· cityContext middleware
2. Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ controllers Î¼Îµ city filters
3. ÎÎ­Î± routes Î³Î¹Î± city management
4. Testing Î¼Îµ Postman

### Phase 3: Frontend Updates

1. City selector Î³Î¹Î± superadmin
2. ÎÎ­Î¿ Cities tab
3. Î ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î¿Î¯ Î³Î¹Î± city_admin role
4. Testing

### Phase 4: Mobile Updates

1. City detection/selection
2. City context
3. Filtering stores by city
4. Testing

### Phase 5: Production Deployment

1. Backup database
2. Run migration
3. Deploy backend
4. Deploy frontend
5. Publish mobile apps
6. Monitor for issues

---

## ğŸ“Š Î•ÎºÏ„Î¯Î¼Î·ÏƒÎ· Î§ÏÏŒÎ½Î¿Ï…

| Task | ÎÏÎµÏ‚ |
|------|------|
| City Model & Migration | 4 |
| Backend Controllers Update | 8 |
| City Management API | 6 |
| Super Admin UI | 8 |
| City Admin Restrictions | 4 |
| Customer App - City Select | 6 |
| Customer App - Auto Detect | 4 |
| Driver App Updates | 4 |
| Testing & Bug Fixes | 8 |
| **Î£ÏÎ½Î¿Î»Î¿** | **~50 ÏÏÎµÏ‚** |

---

## âš ï¸ Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ­Ï‚ Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚

### 1. Socket.IO Rooms

```javascript
// Î¤ÏÏÎ±: socket.join(`order_${orderId}`)
// Multi-city: socket.join(`city_${citySlug}:order_${orderId}`)

// Î‰ ÎºÎ±Î»ÏÏ„ÎµÏÎ±: ÎÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ namespaces
// io.of('/alexandroupoli').on('connection', ...)
// io.of('/kavala').on('connection', ...)
```

### 2. Push Notifications

```javascript
// Î¤ÏÏÎ±: Broadcast ÏƒÎµ ÏŒÎ»Î¿Ï…Ï‚
// Multi-city: Filter by city

// Î‘Î»Î»Î±Î³Î® ÏƒÏ„Î¿ topic structure
// Î¤ÏÏÎ±: "new_order"
// Multi-city: "alexandroupoli_new_order", "kavala_new_order"
```

### 3. Statistics

```javascript
// Superadmin Î²Î»Î­Ï€ÎµÎ¹:
// - Aggregate stats Î±Ï€ÏŒ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Ï€ÏŒÎ»ÎµÎ¹Ï‚
// - Breakdown Î±Î½Î¬ Ï€ÏŒÎ»Î·
// - Comparison Î¼ÎµÏ„Î±Î¾Ï Ï€ÏŒÎ»ÎµÏ‰Î½

// City Admin Î²Î»Î­Ï€ÎµÎ¹:
// - ÎœÏŒÎ½Î¿ Ï„Î± stats Ï„Î·Ï‚ Î´Î¹ÎºÎ®Ï‚ Ï„Î¿Ï… Ï€ÏŒÎ»Î·Ï‚
```

### 4. Settings Inheritance

```javascript
// Global settings (default values)
// â†“
// City settings (override per city)
// â†“
// Store settings (override per store, if needed)
```

---

## ğŸš€ Î ÏŒÏ„Îµ Î½Î± Ï„Î¿ Ï…Î»Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚

**Î¥Î»Î¿Ï€Î¿Î¯Î·ÏƒÎµ Multi-City ÎŸÎ¤Î‘Î:**
- âœ… ÎˆÏ‡ÎµÎ¹Ï‚ Î¾ÎµÎºÎ¬Î¸Î±ÏÎ¿ Ï€Î»Î¬Î½Î¿ Î³Î¹Î± 2+ Ï€ÏŒÎ»ÎµÎ¹Ï‚
- âœ… ÎˆÏ‡ÎµÎ¹Ï‚ Ï‡ÏÏŒÎ½Î¿ Î³Î¹Î± proper testing
- âœ… ÎˆÏ‡ÎµÎ¹Ï‚ backup strategy

**ÎœÎ—Î Ï„Î¿ Ï…Î»Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚ Î±Î½:**
- âŒ Î”ÎµÎ½ ÎµÎ¯ÏƒÎ±Î¹ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Ï‚ Î³Î¹Î± expansion
- âŒ ÎˆÏ‡ÎµÎ¹Ï‚ Ï€Î¿Î»Î»Î¬ pending features
- âŒ Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ stable

---

## ğŸ“ Î•Î½Î±Î»Î»Î±ÎºÏ„Î¹ÎºÎ®: ÎÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Deployments

Î‘Î½ Ï€ÏÎ¿Ï„Î¹Î¼Î¬Ï‚ Î±Ï€Î»Î¿ÏÏƒÏ„ÎµÏÎ· Î»ÏÏƒÎ·:

```
fastdelivery-alex.gr  â†’ MongoDB: fastdelivery_alex
fastdelivery-kavala.gr â†’ MongoDB: fastdelivery_kavala
```

**Î Î»ÎµÎ¿Î½ÎµÎºÏ„Î®Î¼Î±Ï„Î±:**
- ÎœÎ·Î´Î­Î½ Î±Î»Î»Î±Î³Î­Ï‚ ÏƒÏ„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ±
- Î Î»Î®ÏÎ·Ï‚ Î±Ï€Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ·
- Î•ÏÎºÎ¿Î»Î¿ setup

**ÎœÎµÎ¹Î¿Î½ÎµÎºÏ„Î®Î¼Î±Ï„Î±:**
- Î Î¿Î»Î»Î±Ï€Î»Î¬ deployments
- Î Î¿Î»Î»Î±Ï€Î»Î­Ï‚ DBs
- Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ central dashboard

---

## ğŸ“š Related Documentation

- [MongoDB Geospatial Queries](https://docs.mongodb.com/manual/geospatial-queries/)
- [Multi-Tenant Architecture Best Practices](https://docs.microsoft.com/en-us/azure/architecture/guide/multitenant/overview)
- [Socket.IO Namespaces](https://socket.io/docs/v4/namespaces/)

---

*Î‘Ï…Ï„ÏŒ Ï„Î¿ Î­Î³Î³ÏÎ±Ï†Î¿ ÎµÎ¯Î½Î±Î¹ ÏƒÏ‡ÎµÎ´Î¹Î±ÏƒÎ¼ÏŒÏ‚ Î³Î¹Î± Î¼ÎµÎ»Î»Î¿Î½Ï„Î¹ÎºÎ® Ï…Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ·. ÎšÎ±Î¼Î¯Î± Î±Î»Î»Î±Î³Î® Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ ÏƒÏ„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ±.*
